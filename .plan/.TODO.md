# Braintrust Ruby SDK - TODO

> See `.DONE.md` for completed work

## Known Issues / Tech Debt

### High Priority

- [x] **SSL Certificate Verification on macOS**: ✅ FIXED (2025-10-22)
  - **Solution**: Added `openssl` gem v3.3.1+ as runtime dependency
  - Fixed in Ruby/OpenSSL maintainers' release (see https://github.com/ruby/openssl/issues/949)
  - Removed all `VERIFY_NONE` workarounds and ssl_config.rb
  - Now uses proper SSL verification with VERIFY_PEER
  - Tests passing, SSL connections verified working

### Medium Priority

- [x] **Kitchen-Sink Span Export Inconsistency**: ✅ RESOLVED (2025-10-22)
  - Issue was timing-related with concurrent OpenAI API calls
  - Now working correctly

### Low Priority

- [ ] **Parallelism Not Implemented**: Eval.run accepts parallelism parameter but doesn't use it
  - Currently runs cases sequentially
  - Need to implement parallel execution with threads or concurrent-ruby

- [ ] **Testing with/without OpenTelemetry**: Test SDK behavior with optional dependencies
  - Test with OpenTelemetry installed (current default)
  - Test without OpenTelemetry installed (graceful degradation)
  - Test with `tracing: false` parameter
  - Ensure API client, login, and non-tracing features work independently
  - Consider making OpenTelemetry an optional dependency

## Pending Work

### Phase 2: Deferred Items
- [ ] Implement Braintrust.with_state (deferred - not needed yet)
- [x] Implement State#login_in_thread ✅ COMPLETE (2025-10-23) - background thread with retries

### Phase 3: Trace Utilities (Deferred)
- [ ] Write test: permalink generation
- [ ] Implement Trace.permalink
- [ ] Implement Trace.set_parent (for setting parent in context)
- [ ] Implement Trace.get_parent
- [ ] Implement span filtering logic (AI spans filter)

### Phase 4.5: OpenAI Advanced Features

#### Streaming Support ✅ COMPLETE (2025-10-23)
- [x] Add support for `stream_raw` API
- [x] Handle streaming responses and chunks
- [x] Aggregate streaming data for tracing
- [x] Test streaming with console output
- [x] Proper span parenting with `tracer.start_span`
- [x] Automatic chunk aggregation (100+ lines of logic)
- [x] Usage metrics capture with `stream_options.include_usage`

#### Additional Endpoints
- [ ] Embeddings support
- [ ] Assistants API support
- [ ] Fine-tuning API support
- [ ] Images API support

#### Error Handling & Reliability
- [ ] Better error handling for API failures
- [ ] Retry logic with exponential backoff
- [ ] Timeout configuration
- [ ] Rate limiting handling

### Phase 5: API Client (TDD) - ✅ DATASETS COMPLETE

#### lib/braintrust/api.rb ✅
- [x] Write test: API with explicit state
- [x] Write test: API with global state
- [x] Write test: API#datasets returns Datasets instance
- [x] Implement API class with memoized resource accessors
- [x] Add unique_name() test helper for parallel-safe tests

#### lib/braintrust/api/datasets.rb ✅
- [x] Write test: Datasets#list with project_name
- [x] Write test: Datasets#get by project + name
- [x] Write test: Datasets#get_by_id
- [x] Write test: Datasets#create (idempotent)
- [x] Write test: Datasets#insert events
- [x] Write test: Datasets#fetch with pagination
- [x] Implement Datasets class with all methods
- [x] Implement list, get, get_by_id, create, insert, fetch, permalink
- [x] Implement consolidated http_request() function
- [x] Add debug logging with timing information
- [x] Create examples/api/dataset.rb

#### Deferred (API Projects/Experiments)
- [ ] Write test: register_project creates/fetches project
- [ ] Write test: register_experiment creates experiment
- [ ] Write test: register_experiment with update flag
- [ ] Implement API::Projects
- [ ] Implement API::Experiments
- [ ] Move from Internal::Experiments to public API

### Phase 6: Evals - Remaining Items

#### lib/braintrust/eval.rb
- [ ] Implement parallel execution (parallelism parameter)

#### Auto-print Results ✅ COMPLETE (2025-10-23)
- [x] Add `quiet:` parameter to Eval.run (defaults to false)
- [x] Update Result#to_s to Go SDK format
- [x] Auto-print results via `puts result` unless quiet: true
- [x] Format: Experiment name, ID, Link, Duration, Error count
- [x] Updated all tests to use quiet: true
- [x] Updated examples to rely on auto-printing

#### Dataset Integration ✅ COMPLETE (2025-10-22)
- [x] Add `dataset:` parameter to Eval.run (string or hash)
- [x] Support dataset by name (same project as experiment)
- [x] Support dataset by name + explicit project
- [x] Support dataset by ID
- [x] Support dataset with limit option
- [x] Support dataset with version option
- [x] Auto-pagination (fetch all records by default)
- [x] Validation: dataset and cases are mutually exclusive
- [x] Tests for all dataset features
- [x] Example: examples/eval/dataset.rb

#### Remote Functions ✅ COMPLETE (2025-10-23)
- [x] Write test: API::Functions#list with project_name
- [x] Write test: API::Functions#create with function_data and prompt_data
- [x] Write test: API::Functions#invoke by ID
- [x] Write test: API::Functions#delete
- [x] Implement API::Functions class (lib/braintrust/api/functions.rb)
- [x] Write test: Functions.task returns callable
- [x] Write test: Functions.task invokes remote function
- [x] Write test: Functions.scorer returns Scorer
- [x] Write test: Use remote task in Eval.run
- [x] Implement Eval::Functions module (lib/braintrust/eval/functions.rb)
- [x] Add OpenTelemetry tracing for function invocations (type: "function")
- [x] Make State#login idempotent (returns early if already logged in)
- [x] Add automatic state.login in Eval.run to populate org_name
- [x] Create example: examples/eval/remote_functions.rb
- [x] Add remote scorer with LLM classifier and choice_scores
- [x] Tests for all remote function features (4 API tests, 4 Eval tests)

### Phase 7: Examples

#### examples/openai/
- [ ] Create openai_basic.rb
- [ ] Test example runs successfully

#### examples/otel/
- [ ] Create otel_basic.rb
- [ ] Test example runs successfully

#### examples/evals/
- [ ] Create eval_basic.rb
- [ ] Test example runs successfully

### Phase 8: Documentation & Polish

- [ ] Write comprehensive README.md
- [ ] Document all public APIs
- [ ] Add inline code comments
- [ ] Update CONTRIBUTING.md
- [ ] Update CHANGELOG.md
- [ ] Verify 80%+ test coverage
- [ ] Run Standard linter and fix issues
- [ ] Set up CI/CD pipeline
- [ ] Tag v0.1.0 release

## Current Status

**Last Updated**: 2025-10-23 (Session 9)
**Current Phase**: Phase 4.5 - OpenAI Integration Enhancement ✅ COMPLETE
**Test Status**: 115 test runs, 398 assertions, all passing, linter clean
**OpenAI Features**: Vision ✅, Tool Calling ✅, Streaming ✅, Advanced Metrics ✅

## Deferred Items

- API::Projects (move from Internal::Experiments)
- API::Experiments (move from Internal::Experiments)
- Implement Parallelism (Eval.run parallelism parameter)
- OpenAI Responses API (`/v1/responses` endpoint - newer API, lower priority)
- OpenAI Additional Endpoints (embeddings, assistants, fine-tuning, images)
